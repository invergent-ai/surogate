import std.primitives.matmul
import std.primitives.bias
module Linear(
  in_dim: int,
  out_dim: int,
  use_bias: bool = false
):
  """
  Linear projection: y = x @ W^T (+ bias).
  """
  let:
    C = in_dim
    O = out_dim
  params:
    weight: [O, C]
    bias: [O] if use_bias
  forward:
    inputs:
      x: [B, T, C]
    outputs:
      y: [B, T, O]
    graph:
      x -> view(shape=[B * T, C]) -> x_flat
      (x_flat, weight) -> matmul(transpose=NT) -> y_flat
      y_flat -> view(shape=[B, T, O]) -> y_tmp
      if use_bias:
        (y_tmp, bias) -> bias_add() -> y
      else:
        y_tmp -> y
