import std.primitives.rmsnorm
module RMSNorm(
  d_model: int,
  eps: float = 1e-6
):
  """
  RMSNorm over the last dimension.
  """
  let:
    C = d_model
  params:
    weight: [C]
  forward:
    inputs:
      x: [B, T, C]
    outputs:
      y: [B, T, C]
    graph:
      (x, weight) -> rmsnorm(eps=eps) -> (y, _)


module FusedResidualRMSNorm(
  d_model: int,
  eps: float = 1e-6
):
  """
  Fused residual add + RMSNorm: residual_out = residual + x; y = RMSNorm(residual_out).
  """
  let:
    C = d_model
  params:
    weight: [C]
  forward:
    inputs:
      residual: [B, T, C]
      x: [B, T, C]
    outputs:
      residual_out: [B, T, C]
      y: [B, T, C]
    graph:
      (residual, x, weight) -> fused_residual_rmsnorm(eps=eps) -> (residual_out, y, _)
