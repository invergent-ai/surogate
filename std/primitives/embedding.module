# Embedding Primitives
# Native implementations: csrc/src/kernels/encoder.cu

primitive embedding:
  """
  Token embedding lookup.
  """

  forward:
    in: (
      token_ids: [B, T, int32],
      token_embed: [V, C]
    )
    out: [B, T, C]
    _

  backward:
    in: (d_out: [B, T, C], token_ids: [B, T, int32])
    out: d_token_embed: [V, C]
    _

  save: [token_ids]

  impl:
    forward: kernels.encoder_forward
    backward: kernels.encoder_backward


primitive embedding_backward:
  """
  Backward pass for embedding lookup.
  """

  forward:
    in: (
      d_out: [B, T, C],
      token_ids: [B, T, int32]
    )
    out: d_token_embed: [V, C]
    _

  impl:
    forward: kernels.encoder_backward


primitive embedding_with_position:
  """
  Fused token + position embedding (forward only).
  """

  forward:
    in: (
      token_ids: [B, T, int32],
      token_embed: [V, C],
      pos_embed: [T, C]
    )
    out: [B, T, C]
    _

  impl:
    forward: kernels.encoder_forward
