# Mamba / SSM Primitives
# Native implementations: csrc/src/kernels/mamba_kernels.cu

primitive mamba_causal_conv1d:
  """
  Depthwise causal 1D convolution (optional SiLU).
  """

  params:
    kernel_size: int
    silu: bool = false

  forward:
    in: (
      x: [B, D, T],
      weight: [D, 1, kernel_size],
      bias: [D]?
    )
    out: (
      y: [B, D, T],
      conv_state_out: [B, D, kernel_size - 1]
    )
    _

  backward:
    in: (
      d_y: [B, D, T],
      x: [B, D, T],
      weight: [D, 1, kernel_size],
      bias: [D]?
    )
    out: (
      d_x: [B, D, T],
      d_weight: [D, 1, kernel_size],
      d_bias: [D]?
    )
    _

  save: [x]

  impl:
    forward: kernels.mamba_causal_conv1d_forward
    backward: kernels.mamba_causal_conv1d_backward


primitive mamba_selective_scan:
  """
  Selective scan kernel for Mamba2.
  """

  params:
    d_state: int
    groups: int = 1
    chunk_size: int = 256

  forward:
    in: (
      u: [B, D, T],
      delta: [B, D, T],
      A: [D, d_state],
      B: [B, groups, d_state, T],
      C: [B, groups, d_state, T],
      D: [D],
      delta_bias: [D],
      state: [B, D, d_state]?
    )
    out: (
      y: [B, D, T],
      state_out: [B, D, d_state]
    )
    _

  backward:
    in: (
      d_y: [B, D, T],
      u: [B, D, T],
      delta: [B, D, T],
      A: [D, d_state],
      B: [B, groups, d_state, T],
      C: [B, groups, d_state, T],
      D: [D],
      delta_bias: [D],
      state_out: [B, D, d_state]
    )
    out: (
      d_u: [B, D, T],
      d_delta: [B, D, T],
      d_A: [D, d_state],
      d_B: [B, groups, d_state, T],
      d_C: [B, groups, d_state, T],
      d_D: [D],
      d_delta_bias: [D]
    )
    _

  save: [u, delta, A, B, C, D, delta_bias, state_out]

  impl:
    forward: kernels.mamba_selective_scan_forward
    backward: kernels.mamba_selective_scan_backward


primitive mamba_split_proj:
  """
  Split fused Mamba input projection into gate, conv input, and expanded delta.
  """

  params:
    d_inner: int
    conv_dim: int
    num_heads: int
    head_dim: int

  forward:
    in: proj: [B, T, d_inner + conv_dim + num_heads]
    out: (
      gate: [B, T, d_inner],
      conv_in: [B, conv_dim, T],
      delta: [B, d_inner, T]
    )
    _

  impl:
    forward: kernels.mamba_split_proj


primitive mamba_split_conv_out:
  """
  Split convolution output into u, B, and C components for selective scan.
  """

  params:
    d_inner: int
    groups: int
    d_state: int

  forward:
    in: conv_out: [B, d_inner + 2 * groups * d_state, T]
    out: (
      u: [B, d_inner, T],
      B_ssm: [B, groups, d_state, T],
      C_ssm: [B, groups, d_state, T]
    )
    _

  impl:
    forward: kernels.mamba_split_conv_out


primitive mamba_transpose_btd_to_bdt:
  """
  Transpose tensor from (B, T, D) to (B, D, T).
  """

  forward:
    in: x: [B, T, D]
    out: [B, D, T]
    _

  impl:
    forward: kernels.mamba_transpose_btd_to_bdt


primitive mamba_transpose_bdt_to_btd:
  """
  Transpose tensor from (B, D, T) to (B, T, D).
  """

  forward:
    in: x: [B, D, T]
    out: [B, T, D]
    _

  impl:
    forward: kernels.mamba_transpose_bdt_to_btd


primitive mamba_expand_A:
  """
  Expand per-head A_log into per-channel A matrix (FP32).
  """

  params:
    num_heads: int
    head_dim: int
    d_state: int

  forward:
    in: A_log: [num_heads, fp32]
    out: A: [num_heads * head_dim, d_state, fp32]
    _

  impl:
    forward: kernels.mamba_expand_A


primitive mamba_expand_head_param:
  """
  Expand per-head parameters (D, dt_bias) into per-channel vectors (FP32).
  """

  params:
    num_heads: int
    head_dim: int

  forward:
    in: param: [num_heads, fp32]
    out: expanded: [num_heads * head_dim, fp32]
    _

  impl:
    forward: kernels.mamba_expand_head_param


primitive mamba_group_rmsnorm:
  """
  Grouped RMSNorm for Mamba gated activations.
  """

  params:
    eps: float = 1e-6
    groups: int = 1

  forward:
    in: (x: [B, T, D], weight: [D])
    out: (
      y: [B, T, D],
      rstd: [B, T, groups, fp32]
    )
    _

  impl:
    forward: kernels.mamba_group_rmsnorm_forward
