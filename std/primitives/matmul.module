# Matrix Multiplication Primitives
# Native implementations: csrc/src/kernels/matmul.cpp

primitive matmul:
  """
  General matrix multiplication: C = alpha * op(A) @ op(B) + beta * C

  Transpose modes:
  - NN: A[M,K] @ B[K,N]
  - NT: A[M,K] @ B[N,K]
  - TN: A[K,M] @ B[K,N]
  - TT: A[K,M] @ B[N,K]
  """

  params:
    transpose: enum(NN, NT, TN, TT) = NN
    accumulate: bool = false
    alpha: float = 1.0
    beta: float = 0.0

  forward:
    in: (A: [M, K], B: [K, N])
    out: [M, N]
    _

  backward:
    in: (d_C: [M, N], A: [M, K], B: [K, N])
    out: (d_A: [M, K], d_B: [K, N])
    _

  save: [A, B]

  impl:
    forward: kernels.matmul
    backward: kernels.matmul


primitive matmul_strided:
  """
  Matmul that writes output using a custom leading dimension (stride).

  The logical output shape is [M, N], but the underlying buffer may have a
  larger stride to allow fused writes into a larger tensor.
  """

  params:
    transpose: enum(NN, NT, TN, TT) = TN
    accumulate: bool = false
    output_stride: int
    output_offset: int = 0

  forward:
    in: (A: [M, K], B: [K, N])
    out: [M, N]
    _

  impl:
    forward: kernels.matmul_strided_c
