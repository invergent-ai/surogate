# RMSNorm Primitives
# Native implementations: csrc/src/kernels/rmsnorm.cu

primitive rmsnorm:
  """
  Root Mean Square Normalization.
  y = x / sqrt(mean(x^2) + eps) * weight
  """

  params:
    eps: float = 1e-6

  forward:
    in: (x: [*, C], weight: [C])
    out: (y: [*, C], rstd: [*])
    _

  backward:
    in: (d_y: [*, C], x: [*, C], weight: [C], rstd: [*])
    out: (d_x: [*, C], d_weight: [C])
    _

  save: [x, rstd]

  impl:
    forward: kernels.rmsnorm_forward
    backward: kernels.rmsnorm_backward


primitive fused_residual_rmsnorm:
  """
  Fused residual add + RMSNorm.

  residual_out = residual + input
  y = rmsnorm(residual_out)
  """

  params:
    eps: float = 1e-6

  forward:
    in: (residual: [*, C], input: [*, C], weight: [C])
    out: (residual_out: [*, C], y: [*, C], rstd: [*])
    _

  backward:
    in: (
      d_y: [*, C],
      d_residual_next: [*, C],
      residual_out: [*, C],
      weight: [C],
      rstd: [*]
    )
    out: (d_residual: [*, C], d_input: [*, C], d_weight: [C])
    _

  save: [residual_out, rstd]

  impl:
    forward: kernels.fused_residual_rmsnorm_forward
    backward: kernels.fused_residual_rmsnorm_backward
