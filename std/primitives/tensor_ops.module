# Tensor Utility Primitives
# Native implementations: csrc/src/kernels/kernels.cpp, transpose.cu, convert.cu, fill.cu

primitive transpose:
  """
  Transpose a 2D tensor.
  """

  params:
    dim0: int = 0
    dim1: int = 1

  forward:
    in: x: [D0, D1]
    out: [D1, D0]
    _

  backward:
    in: d_out: [D1, D0]
    out: d_x: [D0, D1]
    _

  impl:
    forward: kernels.transpose
    backward: kernels.transpose


primitive vector_add_sr:
  """
  Element-wise add with stochastic rounding: out = scale * (left + right).
  """

  params:
    scale: float = 1.0
    seed: int = 0

  forward:
    in: (left: [*], right: [*])
    out: [*]
    _

  impl:
    forward: kernels.vector_add_sr


primitive convert_dtype:
  """
  Convert tensor dtype.
  """

  params:
    target_dtype: dtype

  forward:
    in: x: [*]
    out: [*, target_dtype]
    _

  backward:
    in: d_out: [*, target_dtype]
    out: d_x: [*]
    _

  impl:
    forward: kernels.convert_dtype
    backward: kernels.convert_dtype


primitive fill_constant:
  """
  Fill tensor with a constant value.
  """

  params:
    shape: [int]
    value: float = 0.0
    dtype: dtype = bf16

  forward:
    in: ()
    out: [shape]
    _

  impl:
    forward: kernels.fill_constant(value)


primitive fill_normal:
  """
  Fill tensor with a normal distribution.
  """

  params:
    shape: [int]
    mean: float = 0.0
    std: float = 1.0
    seed: int = 0
    subsequence: int = 0
    dtype: dtype = bf16

  forward:
    in: ()
    out: [shape]
    _

  impl:
    forward: kernels.fill_normal


primitive zeros:
  """
  Create a zero-filled tensor.
  """

  params:
    shape: [int]
    dtype: dtype = bf16

  forward:
    in: ()
    out: [shape]
    _

  impl:
    forward: cudaMemset


primitive ones:
  """
  Create a one-filled tensor.
  """

  params:
    shape: [int]
    dtype: dtype = bf16

  forward:
    in: ()
    out: [shape]
    _

  impl:
    forward: kernels.fill_constant(1.0)
